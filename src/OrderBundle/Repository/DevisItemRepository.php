<?php

namespace OrderBundle\Repository;

/**
 * DevisItemRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DevisItemRepository extends \Doctrine\ORM\EntityRepository
{
    public function countprods()
    {
        $qb = $this->createQueryBuilder('devis_item')
            ->leftJoin('devis_item.product', 'p')
            ->addSelect('p as prod')
            ->leftJoin('devis_item.devis', 'devis')
            ->addSelect('devis')
            ->addSelect('SUM(devis_item.quantity) as total_quantity')
            ->where("devis.enabled = true")
            ->groupBy('p.name')
            ->orderBy('total_quantity', 'desc');

        return $qb->getQuery()->getResult();
    }

    public function getItemsByCode($code)
    {
        $qb = $this->createQueryBuilder('devis_item')
            ->leftJoin('devis_item.devis', 'd')
            ->addSelect('d')
            ->leftJoin('devis_item.product', 'p')
            ->addSelect('p')
            ->leftJoin('d.orderInfo', 'info')
            ->addSelect('info')
            ->where("info.promo = '".$code."'");
            //->andWhere('d.enabled = true');
        return $qb->getQuery()->getResult();
    }
}
