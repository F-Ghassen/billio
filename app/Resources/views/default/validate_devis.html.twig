{% extends 'base.html.twig' %}

{% block body %}
    {% include 'default/header.html.twig' %}

    <div class="section" style="margin-top: 200px;">
        <div class="container mt-5">
            <div class="row mt-5">
                <div class="col-12 col-lg-6 mt-5">
                    <!-- Billing details -->
                    <h4 class="margin-bottom-20 mb-5">Validation de la commande</h4>
                    {{ form_start(personalinfo_form) }}
                        <div class="row mt-3">
                            <div class="col-12 col-sm-6">
                                {{ form_label(personalinfo_form.customerFirstName) }}
                                {{ form_widget(personalinfo_form.customerFirstName) }}
                            </div>
                            <div class="col-12 col-sm-6">
                                {{ form_label(personalinfo_form.customerLastName) }}
                                {{ form_widget(personalinfo_form.customerLastName) }}
                            </div>
                        </div>
                        <div class="mt-3">
                            {{ form_label(personalinfo_form.customerEmail) }}
                            {{ form_widget(personalinfo_form.customerEmail) }}
                        </div>
                        <div class="mt-3">
                            {{ form_label(personalinfo_form.pays) }}
                            {{ form_widget(personalinfo_form.pays) }}
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 col-sm-6">
                                {{ form_label(personalinfo_form.customerCity) }}
                                {{ form_widget(personalinfo_form.customerCity) }}
                            </div>
                            <div class="col-12 col-sm-6">
                                {{ form_label(personalinfo_form.postalCode) }}
                                {{ form_widget(personalinfo_form.postalCode) }}
                            </div>
                        </div>
                        <div class="mt-3">
                            {{ form_label(personalinfo_form.customerPhone) }}
                            {{ form_widget(personalinfo_form.customerPhone) }}
                        </div>
                        <div class="mt-3">
                            {{ form_label(personalinfo_form.customerAddress) }}
                            {{ form_widget(personalinfo_form.customerAddress) }}
                        </div>
                        <div class="mt-3">
                             {{ form_label(personalinfo_form.paymentMethod) }}
                             {{ form_widget(personalinfo_form.paymentMethod) }}
                        </div>
                        <div class="mt-3">
                            {{ form_label(personalinfo_form.promo) }}
                            <div class="row justify-content-center">
                                <div class="col-lg-12 col-md-12">
                                    {{ form_widget(personalinfo_form.promo) }}
                                </div>
                                <!--div class="btn btn-success col-lg-2 col-md-2 w-75 mt-3 mt-sm-0" id="check-btn">VÃ©rifier</div-->
                            </div>
                        </div>
                </div>

                <div class="col-12 col-md-6 col-lg-5 mt-5 mb-5 ml-lg-auto">
                    <div class="order-details-confirmation">

                        <div class="cart-page-heading">
                            <h5>Votre Commande</h5>
                            <p>Facture</p>
                        </div>

                        <ul class="order-details-form mb-4">
                            <li><span  style="font-size: 25px !important;">Products</span> <span style="font-size: 25px !important;">Total</span></li>
                            {% set subTotal=0 %}
                            {% for item in items1 %}

                            {% set entryInfo = {
                                id: item.product.id,
                                price: (item.product.price-item.product.price*item.promo/100),
                                quantity: item.quantity
                            } %}
                            <div data-entry-info='{{ entryInfo|json_encode|replace("'", "&#39;")|raw }}'>
                                {% if item.promo %}
                                    {% set total = item.quantity*(item.product.price - item.product.price*item.promo/100) %}
                                {% else %}
                                    {% set total = item.quantity*item.product.price %}
                                {% endif %}
                                {% set subTotal = subTotal + total %}
                                <li><b style="font-size: 15px !important;">{{ item.product.name }}</b>
                                    <span style="font-size: 15px !important;">
                                        <s style='color: dimgrey; font-size: 80%'>{{ item.quantity*item.product.price }}</s>
                                        {{ total }} <span>$</span>
                                    </span>
                                </li>
                            </div>
                            {% endfor %}
                            <li><b style="font-size: 15px !important;">Subtotal</b> <span style="font-size: 15px !important;" id="subtotal">{{ subTotal }} $</span></li>
                            <li id="shipping">
                                <b style="font-size: 15px !important;">Shipping</b>
                                {% if subTotal > 200 %}
                                    <b style="font-size: 15px !important;">Free</b>
                                {% else %}
                                    {% set subTotal = subTotal + 5 %}
                                    <span style="font-size: 15px !important;">5 $</span>
                                {% endif %}
                            </li>
                            <li><b style="font-size: 15px !important;">Total</b>
                                <b style="font-size: 20px !important;" id="total">{{ subTotal }} $</b>
                            </li>
                        </ul>

                        <div class="container mb-5">
                            <div class="row justify-content-center mt-5">
                                <div class="col-10 text-center">{{ form_widget(personalinfo_form.save) }}</div>
                            </div>
                        </div>
                        {{ form_rest(personalinfo_form) }}
                        {{ form_end(personalinfo_form) }}
                    </div>
                </div>
            </div><!-- end row -->
        </div><!-- end container -->
    </div>
    {% include 'default/footer.html.twig' %}
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>
    <script>
        $(document).ready(function() {
            //$('#check-btn').on('click', promo);
            $('#personal_info_promo').on('change', promo);

            function promo(){
                var code = $('#personal_info_promo').val();
                var path = Routing.generate('check_code_page', {'code': code});
                $.ajax({
                    url: path,
                    //async: false,
                    beforeSend: function() {
                        //$('#check-btn').unbind('click', promo);
                        $('#personal_info_promo').unbind('change', promo);
                    },
                }).done(function(data) {
                    if(data === 'false') {
                        //console.log(data);
                        $('#personal_info_promo').removeClass('input-success');
                        $('#personal_info_promo').addClass('input-danger');
                        //$('#check-btn').on('click', promo);
                        $('#personal_info_promo').on('change', promo);
                    } else {
                        //console.log(data);
                        $('#personal_info_promo').removeClass('input-danger');
                        $('#personal_info_promo').addClass('input-success');

                        var s = $("#total").html();
                        var news = parseFloat(s) - parseFloat(s) * parseFloat(JSON.parse(data).montant)/100;
                        $("#total").html("<s style='color: dimgrey; font-size: 80%'>" + parseFloat(s) + "</s>&nbsp;&nbsp;<span style='outline: 2px green'>" + news + " $</span>");
                        //console.log($("#total").html());
                    }
                });
            }
        });
    </script>



    <!-- Criteo Basket/Cart Tag -->
    <script type="text/javascript" src="//static.criteo.net/js/ld/ld.js" async="true"></script>

    <script type="text/javascript">
        $(document).ready(function(){

            /**
             * Grab data attribute objects with vanilla JavaScript (ES6)
             */
            document.addEventListener('DOMContentLoaded', () => {

                // Select elements by their data attribute
                var entryInfoElements =
                    document.querySelectorAll('[data-entry-info]');

                // Map over each element and extract the data value
                var entryInfoObjects =
                    Array.from(entryInfoElements).map(
                        item => JSON.parse(item.dataset.entryInfo)
                    );

                // You'll now have an array of objects to work with
                console.log(entryInfoObjects);
                // eg: [{id: 1, subheading: "...", title: "..."}]
            });

            /**
             * Grab data attribute objects with JQuery
             */
            $(() => {

                // Select elements by their data attribute
                var $entryInfoElements = $('[data-entry-info]');

                // Map over each element and extract the data value
                var $entryInfoObjects =
                    $.map($entryInfoElements, item => $(item).data('entryInfo'));

                // You'll now have array of objects to work with
                //console.log($entryInfoObjects); // eg: [{id: 1, subheading: "...", title: "..."}

                window.criteo_q = window.criteo_q || [];
                var deviceType = /iPad/.test(navigator.userAgent) ? "t" : /Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Silk/.test(navigator.userAgent) ? "m" : "d";
                window.criteo_q.push(
                    { event: "setAccount", account: 70191}, // You should never update this line
                    { event: "setEmail", email: "fathallah.ghassen97@gmail.com" }, // Can be an empty string
                    { event: "setSiteType", type: deviceType},
                    { event: "viewBasket", $entryInfoObjects}
                );
            });
        });

    </script>
{% endblock %}